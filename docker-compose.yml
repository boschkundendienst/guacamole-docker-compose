####################################################################################
# docker-compose file for Apache Guacamole
####################################################################################
#
# What does this file do?
#
# Using docker-compose it will:
#
# - create a network 'guacnetwork_compose' with the 'bridge' driver.
# - create a service 'guacd_compose' from 'guacamole/guacd' connected to 'guacnetwork'
# - create a service 'postgres_guacamole_compose' (1) from 'postgres' connected to 'guacnetwork'
# - create a service 'guacamole_compose' (2)  from 'guacamole/guacamole/' conn. to 'guacnetwork'
#
# (2)
#  Make sure you use the same value for 'POSTGRES_USER' and 'POSTGRES_PASSWORD'
#  as configured under (1)
#
# The initial login to the guacamole webinterface is:
#
#     Username: guacadmin
#     Password: guacadmin
#
####################################################################################

version: '2.0'

# networks
# create a network 'guacnetwork_compose' in mode 'bridged'
networks:
  guacnetwork_compose:
    driver: bridge

# services
services:

  # guacd
  guacd:
    container_name: ${GUACD_CONTAINER_NAME}
    image: ${GUACD_IMAGE}
    networks:
      guacnetwork_compose:
    restart: always
    volumes:
    - ./drive:/drive:rw
    - ./record:/record:rw

  # postgres
  #postgres:
  #  container_name: ${POSTGRES_CONTAINER_NAME}
  #  image: ${POSTGRES_IMAGE}
  #  environment:
  #    PGDATA: ${POSTGRES_DATA}
  #    POSTGRES_DB: ${POSTGRES_DATABASE}
  #    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #    POSTGRES_USER: ${POSTGRES_USER}
  #  networks:
  #    guacnetwork_compose:
  #  restart: always
  #  volumes:
  #  - ./init:/docker-entrypoint-initdb.d:z
  #  - ./data:/var/lib/postgresql/data:Z

  # guacamole
  guacamole:
    container_name: ${GUACAMOLE_CONTAINER_NAME}
    image: ${GUACAMOLE_IMAGE}
    depends_on:
    - guacd
    - postgres
    environment:
      GUACD_HOSTNAME: ${GUACD_HOSTNAME}
      GUACAMOLE_HOME: ${GUACAMOLE_HOME}
      POSTGRES_DATABASE: ${POSTGRES_DATABASE}
      POSTGRES_HOSTNAME: ${POSTGRES_HOSTNAME}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER}
    links:
    - guacd
    networks:
      guacnetwork_compose:
    ports:
    - 8080:8080/tcp # Guacamole is on :8080/guacamole
    restart: always
    volumes:
    - "./guac_home:/guac_home"

  mysql:
    image: mysql
    restart: always
    container_name: ${MYSQL_CONTAINER_NAME}
    environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
        MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
        - "./mysql:/var/lib/mysql"
        - "./mysql_init/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro"
    networks:
      guacnetwork_compose: