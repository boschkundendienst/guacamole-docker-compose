####################################################################################
# docker-compose file for Apache Guacamole
####################################################################################
#
# What does this file do?
#
# Using docker-compose it will:
#
# - create a network 'guacnetwork_compose' with the 'bridge' driver.
# - create a service 'guacd_compose' from 'guacamole/guacd' connected to 'guacnetwork'
# - create a service 'postgres_guacamole_compose' (1) from 'postgres' connected to 'guacnetwork'
# - create a service 'guacamole_compose' (2)  from 'guacamole/guacamole/' conn. to 'guacnetwork'
#
# (2)
#  Make sure you use the same value for 'POSTGRES_USER' and 'POSTGRES_PASSWORD'
#  as configured under (1)
#
# The initial login to the guacamole webinterface is:
#
#     Username: guacadmin
#     Password: guacadmin
#
####################################################################################

version: '2.0'

# networks
# create a network 'guacnetwork_compose' in mode 'bridged'
networks:
  guacnetwork_compose:
    driver: bridge

# services
services:

  # guacd
  guacd:
    container_name: ${GUACD_CONTAINER_NAME}
    image: ${GUACD_IMAGE}
    networks:
      guacnetwork_compose:
    restart: always
    volumes:
    - ./drive:/drive:rw
    - ./record:/record:rw

  mysql:
    image: mysql
    restart: always
    container_name: ${MYSQL_CONTAINER_NAME}
    environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
        MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
        - "./mysql:/var/lib/mysql"
        - "./mysql_init/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro"
    networks:
      guacnetwork_compose:

  # guacamole
  guacamole:
    container_name: ${GUACAMOLE_CONTAINER_NAME}
    image: ${GUACAMOLE_IMAGE}
    depends_on:
    - guacd
    - mysql
    environment:
        GUACAMOLE_HOME: ${GUACAMOLE_HOME}
        MYSQL_HOSTNAME: ${MYSQL_HOSTNAME}
        MYSQL_DATABASE: ${MYSQL_DATABASE}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
        GUACD_HOSTNAME: ${GUACD_HOSTNAME}
        GUACD_PORT: 4822
        LDAP_HOSTNAME: ${LDAP_HOSTNAME}
        LDAP_PORT: ${LDAP_PORT}
        LDAP_ENCRYPTION_METHOD: ${LDAP_ENCRYPTION_METHOD}
        LDAP_USER_BASE_DN: ${LDAP_USER_BASE_DN}
        LDAP_GROUP_BASE_DN: ${LDAP_GROUP_BASE_DN}
        LDAP_SEARCH_BIND_DN: ${LDAP_SEARCH_BIND_DN}
        LDAP_SEARCH_BIND_PASSWORD: ${LDAP_SEARCH_BIND_PASSWORD}
        LDAP_USERNAME_ATTRIBUTE: ${LDAP_USERNAME_ATTRIBUTE}
        LDAP_GROUP_NAME_ATTRIBUTE: ${LDAP_GROUP_NAME_ATTRIBUTE}
        LDAP_MEMBER_ATTRIBUTE: ${LDAP_MEMBER_ATTRIBUTE}
        LDAP_USER_SEARCH_FILTER: ${LDAP_USER_SEARCH_FILTER:-(&(objectCategory=person)(objectclass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))}
        TOTP_ISSUER: ${FQDN_HOST_NAME}
    links:
    - guacd
    networks:
      guacnetwork_compose:
    ports:
    - 8080:8080/tcp # Guacamole is on :8080/guacamole
    restart: always
    volumes:
    - "./guac_home:/guac_home"